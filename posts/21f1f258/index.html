<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>探秘 Web 水印技术 | LemonGo97のBlog</title><meta name="description" content="Web 水印技术在信息安全和版权保护等领域有着广泛的应用，对防止信息泄露或知识产品被侵犯有重要意义。水印根据可见性可分为可见水印和不可见水印（盲水印），本文将分别予以介绍，带你探秘 web 水印技术。 可见水印最简单的水印一种比较常见的简单水印场景是给文章、表格加上 logo 水印，用以申明版权。  这里想要的效果就是一个浅浅的 logo 平铺展示。实现起来也比较简单，只需制作一个半透明的 log"><meta name="keywords" content="Java,Linux,BigData,MySQL,MongoDB"><meta name="author" content="LemonGo97"><meta name="copyright" content="LemonGo97"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://blog.lemongo97.com/posts/21f1f258/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><meta property="og:type" content="article"><meta property="og:title" content="探秘 Web 水印技术"><meta property="og:url" content="https://blog.lemongo97.com/posts/21f1f258/"><meta property="og:site_name" content="LemonGo97のBlog"><meta property="og:description" content="Web 水印技术在信息安全和版权保护等领域有着广泛的应用，对防止信息泄露或知识产品被侵犯有重要意义。水印根据可见性可分为可见水印和不可见水印（盲水印），本文将分别予以介绍，带你探秘 web 水印技术。 可见水印最简单的水印一种比较常见的简单水印场景是给文章、表格加上 logo 水印，用以申明版权。  这里想要的效果就是一个浅浅的 logo 平铺展示。实现起来也比较简单，只需制作一个半透明的 log"><meta property="og:image" content="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/all_default.jpg"><meta property="article:published_time" content="2023-01-06T09:47:52.000Z"><meta property="article:modified_time" content="2023-01-06T09:47:52.000Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2023-01-06 17:47:52'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="LemonGo97のBlog" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="https://coding-net-production-static-ci.codehub.cn/d70d0fa9-08d5-4fc7-ba82-7b73fee22292.jpg?imageMogr2/auto-orient/format/jpeg/cut/700x700x0x0" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">60</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">39</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E8%A7%81%E6%B0%B4%E5%8D%B0"><span class="toc-number">1.</span> <span class="toc-text">可见水印</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E6%B0%B4%E5%8D%B0"><span class="toc-number">1.1.</span> <span class="toc-text">最简单的水印</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E9%A1%B5%E9%9D%A2%E6%B0%B4%E5%8D%B0"><span class="toc-number">1.2.</span> <span class="toc-text">全页面水印</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%B0%B4%E5%8D%B0"><span class="toc-number">1.3.</span> <span class="toc-text">动态水印</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.1.</span> <span class="toc-text">服务端方案</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Canvas-%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.2.</span> <span class="toc-text">Canvas 方案</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SVG-%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.3.</span> <span class="toc-text">SVG 方案</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B0%B4%E5%8D%B0%E5%AE%89%E5%85%A8"><span class="toc-number">1.4.</span> <span class="toc-text">水印安全</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Shadow-DOM"><span class="toc-number">1.4.1.</span> <span class="toc-text">Shadow DOM</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Mutation-Observer"><span class="toc-number">1.4.2.</span> <span class="toc-text">Mutation Observer</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E8%A7%81%E6%B0%B4%E5%8D%B0%EF%BC%88%E7%9B%B2%E6%B0%B4%E5%8D%B0%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">不可见水印（盲水印）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LSB-%E6%B0%B4%E5%8D%B0"><span class="toc-number">2.1.</span> <span class="toc-text">LSB 水印</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%91%E5%9F%9F%E6%B0%B4%E5%8D%B0"><span class="toc-number">2.2.</span> <span class="toc-text">频域水印</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Web-%E4%B8%AD%E7%9A%84%E6%95%B0%E5%AD%97%E6%B0%B4%E5%8D%B0%E5%BA%94%E7%94%A8"><span class="toc-number">2.3.</span> <span class="toc-text">Web 中的数字水印应用</span></a></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/all_default.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">LemonGo97のBlog</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">【转载】 探秘 Web 水印技术</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-01-06T09:47:52.000Z" title="发表于 2023-01-06 17:47:52">2023-01-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-01-06T09:47:52.000Z" title="更新于 2023-01-06 17:47:52">2023-01-06</time></span></div><div class="meta-secondline"> </div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p><strong>Web 水印技术</strong>在信息安全和版权保护等领域有着广泛的应用，对防止信息泄露或知识产品被侵犯有重要意义。水印根据可见性可分为可见水印和不可见水印（盲水印），本文将分别予以介绍，带你探秘 web 水印技术。</p>
<h3 id="可见水印"><a href="#可见水印" class="headerlink" title="可见水印"></a>可见水印</h3><h4 id="最简单的水印"><a href="#最简单的水印" class="headerlink" title="最简单的水印"></a>最简单的水印</h4><p>一种比较常见的简单水印场景是给文章、表格加上 <code>logo</code> 水印，用以申明版权。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/1452006909f9c251a5f800126aaa2cf7.jpeg" alt=""></p>
<p>这里想要的效果就是一个浅浅的 <code>logo</code> 平铺展示。实现起来也比较简单，只需制作一个半透明的 <code>logo</code> 图片，设为文章或者表格的背景图片即可。仅需一行 <code>CSS</code> 声明。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background-image</span>:<span class="built_in">url</span>(<span class="string">&quot;./logo.png&quot;</span>);  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>实现图片平铺关键的 <code>CSS</code> 属性是 <code>background-repeat</code>，值为 <code>repeat</code> 时是平铺，这也是它的默认值，所以可以省略。</p>
<h4 id="全页面水印"><a href="#全页面水印" class="headerlink" title="全页面水印"></a>全页面水印</h4><p>照葫芦画瓢，如果要给整个 <code>Web</code> 页面加上水印，是不是给页面的 <code>body</code> 元素设置背景图片平铺展示就可以了呢？</p>
<p>然而通常并不会这么处理，因为文章和表格内容多以文本为主，不会明显遮挡水印，而一个完整的页面往往还包含很多其他页面元素，比如图片、视频、控件等等，它们很可能会遮挡住背景图片，从而影响水印效果。</p>
<p>所以，为了避免被其他元素遮挡，针对页面的水印一般会使用一个层级比较高且覆盖整个页面的元素来承载。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span><span class="selector-class">.watermark</span>&#123;  </span><br><span class="line">  <span class="attribute">position</span>: fixed;  </span><br><span class="line">  <span class="attribute">left</span>:<span class="number">0</span>;  </span><br><span class="line">  <span class="attribute">top</span>:<span class="number">0</span>;  </span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100vw</span>;  </span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100vh</span>;  </span><br><span class="line">  <span class="attribute">background-image</span>:<span class="built_in">url</span>(<span class="string">&quot;./logo.png&quot;</span>);  </span><br><span class="line">  <span class="attribute">opacity</span>: .<span class="number">5</span>;  </span><br><span class="line">  <span class="attribute">z-index</span>: <span class="number">3000</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样一来，其他元素就遮挡不住水印了。不过，这个 <code>div</code> 反过来可能会遮挡页面其他元素，影响页面元素操作。还需要一条关键的 <code>CSS</code> 声明来破解这个问题 :</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">pointer-events</span>: none;  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个 <code>CSS</code> 声明会使该元素“可穿透”，“看得见、摸不着”，不再影响页面操作。</p>
<h4 id="动态水印"><a href="#动态水印" class="headerlink" title="动态水印"></a>动态水印</h4><p>很多时候，给页面加水印的目的并不是申明版权，而是为了支持溯源。此时水印的内容并不会只是一个 <code>logo</code>，通常会包含用户信息，比如用户名、UID、手机号等等。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/6426b18102827952e9bc497fa6148480.jpeg" alt=""></p>
<p>这就意味着，每个用户的水印内容是不同的，无法通过提前准备好一张图片来满足了。这种场景往往需要根据用户信息动态生成图片。</p>
<p>我们来看下几种主流的动态生成水印图片的方式：</p>
<h5 id="服务端方案"><a href="#服务端方案" class="headerlink" title="服务端方案"></a>服务端方案</h5><p>传统的方式是在服务端生成图片。页面上发起的图片请求中可以附带用户信息，服务端根据这些参数动态生成图片，并将图片数据作为该请求的响应返给页面，页面拿到后将其用作水印。</p>
<p>这种方式的优点是兼容性好，缺点是需要前后端配合，增加了页面请求和服务端资源开销，防攻击能力也较差。</p>
<h5 id="Canvas-方案"><a href="#Canvas-方案" class="headerlink" title="Canvas 方案"></a>Canvas 方案</h5><p><code>HTML5</code> 引入 <code>Canvas</code> 特性使得浏览器自身具备了绘图能力。经过多年的发展，主流浏览器基本都已可以提供良好的支持。通过 <code>Canvas</code> 可以轻松绘制图片，并可将图片数据导出，用于页面图片或背景。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> canvasElement = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>);  </span><br><span class="line"><span class="keyword">const</span> context = canvasElement.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);  </span><br><span class="line">canvasElement.<span class="property">width</span> = <span class="number">200</span>;  </span><br><span class="line">canvasElement.<span class="property">height</span> = <span class="number">200</span>;  </span><br><span class="line">context.<span class="title function_">rotate</span>((-<span class="number">30</span> * <span class="title class_">Math</span>.<span class="property">PI</span>) / <span class="number">180</span>);  </span><br><span class="line">context.<span class="property">font</span> = <span class="string">&#x27;400 26px Arial&#x27;</span>;  </span><br><span class="line">context.<span class="property">fillStyle</span> = <span class="string">&#x27;#B9C0CA&#x27;</span>;  </span><br><span class="line">context.<span class="property">textAlign</span> = <span class="string">&#x27;center&#x27;</span>;  </span><br><span class="line">context.<span class="property">textBaseline</span> = <span class="string">&#x27;middle&#x27;</span>;  </span><br><span class="line">context.<span class="title function_">fillText</span>(<span class="string">&#x27;水印文字&#x27;</span>, <span class="number">70</span>, <span class="number">130</span>);  </span><br><span class="line"><span class="keyword">const</span> watermark = canvasElement.<span class="title function_">toDataURL</span>(<span class="string">&#x27;image/png&#x27;</span>);  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过上述示例代码可拿到水印图片的 <code>data URI</code> 数据，用作水印承载元素的背景图片平铺展示即可。</p>
<p>这种方式不需要服务端配合，在前端就可以完成，且有助于减少请求和服务端资源开销。曾经面临的浏览器兼容问题现在也不再是问题，该方案已逐渐流行起来。</p>
<h5 id="SVG-方案"><a href="#SVG-方案" class="headerlink" title="SVG 方案"></a>SVG 方案</h5><p>对于纯文字的水印来说，有没有办法不生成图片而直接实现平铺呢？</p>
<p>动态创建大量 <code>DOM</code> 节点，通过 <code>CSS</code> 控制排列当然可以实现，但是繁琐且性能差，优雅更无从谈起。</p>
<p>不妨换个角度思考，有没有办法让文字不转成图片就可以用作 <code>background-image</code> 属性的值呢？这样就可以利用 <code>background-repeat</code> 实现平铺效果了。</p>
<p>这时候可以考虑使用 <code>SVG</code>，因为 <code>SVG</code> 具有文本和图像的双重特性。看上去是文本，然而在很多场景可以当做图片使用。</p>
<p>我们可以通过 <code>SVG</code> 的相关属性精准控制字体位置、大小、颜色、透明度和旋转角度等参数。如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;200&quot;</span> <span class="attr">height</span>=<span class="string">&quot;200&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">text</span> <span class="attr">x</span>=<span class="string">&quot;50%&quot;</span> <span class="attr">y</span>=<span class="string">&quot;50%&quot;</span> <span class="attr">font-size</span>=<span class="string">&quot;30&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;#a2a9b6&quot;</span> <span class="attr">fill-opacity</span>=<span class="string">&quot;0.3&quot;</span> <span class="attr">font-family</span>=<span class="string">&quot;system-ui, sans-serif&quot;</span> <span class="attr">text-anchor</span>=<span class="string">&quot;middle&quot;</span> <span class="attr">dominant-baseline</span>=<span class="string">&quot;middle&quot;</span> <span class="attr">transform</span>=<span class="string">&#x27;rotate(-45, 100 100)&#x27;</span>&gt;</span>水印文字<span class="tag">&lt;/<span class="name">text</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span>  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>考虑到浏览器兼容性，用作背景图片时，建议将 <code>SVG</code> 编码为 <code>Base64</code>（或转义特定字符）:</p>
</blockquote>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">&quot;data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1zaXplPSIzMCIgZmlsbD0iI2EyYTliNiIgZmlsbC1vcGFjaXR5PSIwLjMiIGZvbnQtZmFtaWx5PSJzeXN0ZW0tdWksIHNhbnMtc2VyaWYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRyYW5zZm9ybT0ncm90YXRlKC00NSwgMTAwIDEwMCknPuawtOWNsOaWh+WtlzwvdGV4dD48L3N2Zz4=&quot;</span>);  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/c0757a349954269a2d140d98059f6fa8.jpeg" alt=""></p>
<h4 id="水印安全"><a href="#水印安全" class="headerlink" title="水印安全"></a>水印安全</h4><p>水印是用来保护信息安全的。信息要安全，首先要确保水印自身的安全，提高水印的防攻击（篡改、删除等）能力。</p>
<p>可见水印大都是基于 <code>DOM</code> 的，找到这个 <code>DOM</code> 节点，通过浏览器插件、抓包工具等在页面上注入一段 <code>JavaScript</code> 或者 <code>CSS</code> 代码对其进行篡改或删除并不困难。</p>
<p>防止外部代码篡改，一种思路是把水印元素封装起来，与外部环境进行隔离。</p>
<h5 id="Shadow-DOM"><a href="#Shadow-DOM" class="headerlink" title="Shadow DOM"></a>Shadow DOM</h5><p>在 <code>Chrome</code> 逐步统治浏览器江湖之后，谷歌正野心勃勃的推广 <code>Web Components</code> 技术。该技术允许在 <code>Web</code> 中创建可重用的小部件或组件。组件化开发在前端业界已经流行相当长一段时间了，这主要得益于前端三大框架的推崇，但具体组件标准是由框架各自制定的，而 <code>Web Components</code> 可理解为 <code>Web</code> 标准化的组件。</p>
<p><code>Web Components</code> 的一个重要特性就是<code>“封装”</code>，即可以将标记结构、样式和行为隐藏起来，并与页面上的其他代码相隔离。比如我们熟悉的 <code>video</code> 元素，它的进度条、按钮等控件都已被封装。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/72c6ffa0d3db1341385fe6aaa5524cd6.jpeg" alt=""></p>
<p><code>Shadow DOM</code> 接口是<code>“封装”</code>特性的关键所在，它可以将一个隐藏的、独立的 <code>DOM</code> 附加到一个元素上。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/8c3b6ecae517c89f530f1e833546ce40.jpeg" alt=""></p>
<p>为了提高 <code>web</code> 水印的隐蔽性，同时避免受外部代码影响，从而在一定程度上防止篡改，可以考虑把水印元素放在 <code>Shadow DOM</code> 中。</p>
<p>来看下 <code>Shadow DOM</code> 的基本用法。使用 <code>Element.attachShadow()</code> 方法来将一个 <code>shadow root</code> 附加到任何一个元素上。它接受一个配置对象作为参数，该对象有一个 <code>mode</code> 属性，值可以是 <code>open</code> 或者 <code>closed</code> 。<code>open</code> 表示可以通过页面内的 <code>JavaScript</code> 方法来获取 <code>Shadow DOM</code>。而 <code>closed</code> 则表示不可以从外部获取 <code>Shadow DOM</code> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Element</span>.<span class="title function_">attachShadow</span>(&#123;<span class="attr">mode</span>: <span class="string">&#x27;closed&#x27;</span>&#125;);  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/7d4bf4bdf2b80015d10d6c59fb1c15fa.jpeg" alt=""></p>
<p>样式怎么隔离呢？<code>Shadow DOM</code> 中的样式本身就是隔离的，除非主动使用 <code>CSS</code> 变量、<code>part</code> 属性等暴露，外部样式是不会影响到组件内的。</p>
<h5 id="Mutation-Observer"><a href="#Mutation-Observer" class="headerlink" title="Mutation Observer"></a>Mutation Observer</h5><p><code>Shadow DOM</code> 提高了水印的隐蔽性，同时可以防止外部代码修改。除此之外，还有一种常见的攻击场景——人为修改，比如在浏览器控制台直接修改或删除对应的 <code>DOM</code> 元素。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/807dd6a11c4156ca585c0231ad9c63d8.jpeg" alt=""></p>
<p>可以考虑<code>“监听”</code>这种行为，一旦发生就马上修复，比如重新插入一个。那怎么实现这种<code>“监听”</code>呢？现代浏览器中有多种观察者（<code>Observer</code>），比如<code>IntersectionObserver</code>、<code>PerformanceObserver</code>、<code>ResizeObserver</code>、<code>ReportingObserver</code>、<code>MutationObserver</code> 等。其中，<code>MutationObserver</code> 就可以用来监听 <code>DOM</code> 变动，<code>DOM</code> 的任何变动，比如节点的增减、属性的变动、文本内容的变动，通过该 <code>API</code> 都可以得到通知。</p>
<p>所以可以使用 <code>MutationObserver API</code> 来监听水印元素 <code>DOM</code> 变化，一旦监听到 <code>DOM</code> 元素被修改或者删除，就立即重新插入一个。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/1d01f7edb1fc7955af0cb71381d8ee45.gif" alt=""></p>
<h3 id="不可见水印（盲水印）"><a href="#不可见水印（盲水印）" class="headerlink" title="不可见水印（盲水印）"></a>不可见水印（盲水印）</h3><p>不可见水印也叫盲水印、隐水印，顾名思义是一种看不到的水印，看不到还要它做什么呢？其实，不可见水印在一些对安全性要求较高的场景意义还是蛮大的。不可见水印通常具有比可见水印更好的隐蔽性和抗攻击性。虽不可见，但通过一定的技术手段是可以将水印信息从其载体上提取出来的，这就使得其载体具备了溯源能力，在关键时刻往往能发挥大作用。</p>
<p>我总结不可见水印相对可见水印至少有以下三个明显的优势：</p>
<ul>
<li><p>更好的观感。可见水印总给人一种“膏药感”，甚至会引起部分人的不适，而不可见水印则不会有这个问题。</p>
</li>
<li><p>更佳的隐蔽性。用户基本感知不到水印的存在。</p>
</li>
<li><p>更强的抗攻击性。可见水印更容易受到攻击，而不可见水印除了隐蔽性比较强之外，其自身往往还具备比较强的抗攻击能力。</p>
</li>
</ul>
<p>不可见水印（盲水印）属于信息隐匿技术（也叫隐写术），历史悠久，手段繁多。在现代，随着计算机网络技术的发展，数字产品的信息安全和版权保护也已成为信息隐匿技术的一个重要课题。隐写术在数字音频、数字视频和数字图像领域有着非常广泛的应用。</p>
<p><code>Web</code> 上基于 <code>DOM</code> 的盲水印大都不靠谱，而另一方面数字图像是信息隐藏和数字水印领域研究最多和最早的一种载体，<strong>相较于 Web，数字图像领域有着更为成熟的数字水印算法</strong>。我们不妨先来看下数字图像领域的常见盲水印技术。</p>
<p>在说数字水印之前，这里介绍一些数字图像的基础知识。</p>
<p>数字图像（位图）是由像素（<code>pixel</code>）组成。</p>
<ul>
<li><p>非黑即白的二值图像，<code>1</code> 个 <code>bit</code> 即可表示 <code>1</code> 个像素（黑白两种状态）。所以 <code>1</code> 个字节（<code>byte</code>）可以表示 <code>8</code> 个像素。</p>
</li>
<li><p>灰度图，<code>1</code> 个像素有 <code>256</code> 种状态（<code>2</code> 的 <code>8</code> 次方），需要 <code>8</code> 个 <code>bit</code>，即 <code>1</code> 个字节。</p>
</li>
<li><p>彩色的 <code>RGB</code> 图，有 <code>R</code> / <code>G</code> / <code>B</code> 三个通道，每个通道 <code>256</code> 种状态，使用 <code>1</code> 个字节表示，共需 <code>3</code> 个字节表示 <code>1</code> 个像素。</p>
</li>
<li><p><code>RGBA</code> 图，在 <code>R</code> / <code>G</code> / <code>B</code> 三个通道基础上增加了一个透明度通道，<code>256</code> 种状态，额外需要 <code>1</code> 个字节，共需要 <code>4</code> 个字节表示一个像素。</p>
</li>
</ul>
<p>通常，考虑到计算速度和性能，图像处理和图像识别大都会将图像转成灰度图或者选择其中一个通道进行。</p>
<h4 id="LSB-水印"><a href="#LSB-水印" class="headerlink" title="LSB 水印"></a>LSB 水印</h4><p>如上文所述，灰度图像的一个像素有 <code>256</code> 种状态，通常用灰度值（ <code>0-255</code> ）表示，<code>0</code> 表示黑色，<code>255</code> 表示白色，灰度值越大表示亮度越高。</p>
<p>灰度可用一个字节，即 <code>8</code> 比特二进制数表示，其中最高位对图像的贡献最大，最低位对图像的贡献最小，称为最低比特位（<code>Least Significant Bit</code>，<code>LSB</code>）。</p>
<p>如果将一个图像所有像素的比特位抽出来，就构成了 <code>8</code> 个不同的位平面，从 <code>LSB</code>（最低有效位 <code>0</code>）到 <code>MSB</code>（最高有效位 <code>7</code>）。位平面从低位到高位，图像的特征逐渐变得复杂，细节不断增加，相邻比特的相关性也越强。而比特位越低包含的图像信息就越少，最低位平面类似于随机噪声。因此，改变低位对图像的成像质量影响不大。</p>
<p><code>LSB</code> 水印就是利用了这一点，用水印信息替换载体图像的最低比特位，这样原图像的 <code>7</code> 个高位平面就与表示水印信息的最低位平面组成了新的图像。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/0169c9373a631b3e95707fb6441a47f1.jpeg" alt=""></p>
<p><code>LSB</code> 水印鲁棒性（防攻击性）较差，水印信息容易被抹去。</p>
<h4 id="频域水印"><a href="#频域水印" class="headerlink" title="频域水印"></a>频域水印</h4><p>将数字图像用一个矩阵来表示，是图像的空间域表示方法，<code>LSB</code> 就是在图像的空间域隐藏信息，鲁棒性较差。而在图像信号的频域（变换域）中隐藏信息要比在空间域中隐藏信息具有更好的鲁棒性。那么如何把图像信号从空间域转换到频域呢？这里就需要用到大名鼎鼎的 <code>傅里叶变换</code> 了。</p>
<p>法国数学家傅里叶大家一定不陌生，高数里就有傅里叶级数。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/14ad3a3b53bc5b71b25e02a2c6eb920b.jpeg" alt=""></p>
<p>傅里叶提出的傅里叶变换（<code>Fourier transform</code>）理论，表示能将满足一定条件的某个函数表示成三角函数（正弦和/或余弦函数）或者它们的积分的线性组合，可用于把信号从时间域（或空间域）变换到频率域。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/529260d2d55a6aea24bc66e7299c8f35.jpeg" alt=""></p>
<p>在此之前人们对信号的分析主要集中在空间域，傅里叶变换的提出为频域分析奠定了基础，有助于解决许多图像的问题。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/397d04d93e4c1aa5b808139b8dc866fe.jpeg" alt=""></p>
<p>傅里叶变换在数字图像处理领域有着极为重要的应用，图像领域变换的实质是把图像函数展开成具有不同空间频率的正、余弦信号的叠加，也就是说任何图像都可以分解为若干个频率不同的亮度呈正弦变化的图像之和。把图像从空间域变换到频率域后，就能够实现对图像数据进行不同频率成分的提取。对于图像信号来说，可以把灰度（亮度）看做频率，傅里叶变换可作为图像灰度值形成的空间域与其频率域的桥梁。</p>
<p>在频域中隐藏信息就是傅里叶变换在数字图像处理领域的一个典型应用场景。通常多选择在图像频域的中频部分嵌入信息，因为高频部分易于被各种信号处理方法破坏，而人的视觉又对低频部分比较敏感，容易察觉低频部分的变化。</p>
<p>在图像频域嵌入水印信息的大致流程为：把原始图像通过离散傅里叶变换转换到频域（变换域），把水印文字信息混入，再经过离散傅里叶变换的逆变换，便得到了载有水印信息的图像。水印信息隐匿性较好。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/a29a6c37f4141251baec7a83ca897e4e.jpeg" alt=""></p>
<p>光说不练假把式，操练起来。</p>
<p>下图是我随手拍的鹅厂北京总部大楼一角。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/4259996300d2581a5b5086f80e9d4ae8.jpeg" alt=""></p>
<p>对上图的一个通道进行离散傅里叶变换，在其变换域（频域）加入水印文字（fransli）后，再进行离散傅里叶变换的逆变换，便得到了下图。怎么样，看不到水印信息吧？</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/b2af0fb0281fee0bb27300b13e5ce110.jpeg" alt=""></p>
<p>对上图进行离散傅里叶变换，将图片转换到频域（变换域），我们可以清楚的看到嵌入的水印文字（下图）。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/b068cd7fa7976e7977faf37855f64d46.jpeg" alt=""></p>
<p>频域盲水印具有比较好的防攻击性，我们来测试一下。</p>
<p>我们截取图像中的一部分并重新采样，然后尝试提取水印信息。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/a838b934315831073c69cf1cbb9597c7.jpeg" alt=""></p>
<p>可以看到还是有很大概率可以提取到有效水印信息的。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/6389dcb695c80241e433af31f964670d.jpeg" alt=""></p>
<h4 id="Web-中的数字水印应用"><a href="#Web-中的数字水印应用" class="headerlink" title="Web 中的数字水印应用"></a>Web 中的数字水印应用</h4><p>上面介绍了几种常见的不可见水印（盲水印）实现方式，其中鲁棒性比较好的是基于频域的数字图像盲水印，但这种水印主要是针对数字图像，而 Web 上的内容载体并不一定都是图片，常见的需要加水印的载体除了图片还有文本、表格等，这些场景该如何应用频域盲水印呢？</p>
<p>或许，<code>Canvas</code> 就是答案。</p>
<p><strong>Reference</strong></p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/Web_Components">Web Components</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/Web_Components/Using_shadow_DOM">shadow DOM</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.zhangxinxu.com/wordpress/2020/10/text-as-css-background-image/">如何让文字作为 CSS 背景图片显示？</a></p>
</li>
<li><p>《数字图像隐写分析》</p>
</li>
<li><p>《数字图像处理原理与实践》</p>
</li>
<li><p>《数据隐藏技术揭秘》</p>
</li>
</ul>
<p>本文转自 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/bXpDxN2tTS9FvVQMqLGB2w">https://mp.weixin.qq.com/s/bXpDxN2tTS9FvVQMqLGB2w</a>，如有侵权，请联系删除。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">fransli</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/bXpDxN2tTS9FvVQMqLGB2w">https://mp.weixin.qq.com/s/bXpDxN2tTS9FvVQMqLGB2w</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.lemongo97.com" target="_blank">LemonGo97のBlog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/all_default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/5244d648/"><img class="prev-cover" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/default_cover_1.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">从 SVN 到 Git 开发实用命令总结</div></div></a></div><div class="next-post pull-right"><a href="/posts/8c24d42a/"><img class="next-cover" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/default_cover_1.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">虚拟内存 &amp; I/O &amp; 零拷贝</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By LemonGo97</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/instant.page/5.1.0/instantpage.min.js" type="module" defer></script><script src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.3.1/lazyload.iife.min.js" async></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    window.valine = new Valine({
      el: '#vcomment',
      appId: 'w7vT5VedMPyGHyDYppcacmtw-gzGzoHsz',
      appKey: 'YxBl09Aj50g5Ld621aydI4pz',
      placeholder: '来和大家一起讨论吧！',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    });
    if ('nick,mail') { valine.config.requiredFields= 'nick,mail'.split(',') }
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div></div></body></html>