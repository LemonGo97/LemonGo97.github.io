<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Druid SQL解析工具的使用 | LemonGo97のBlog</title><meta name="description" content="前言最近在项目运行过程中，需要对标准SQL进行解析，然后对SQL进行改写，在各种查找对比后选中了Alibaba Druid来进行解析SQL（如非特制，以下均简称 Druid） Druid官方的wiki说的还算明白，但可惜的是没有相关API文档。 官方文档1. SQL Parser如需查看原文：SQL Parser 1. 简介SQL Parser是Druid的一个重要组成部分，Druid内置使用SQ"><meta name="keywords" content="Java,SQL,Druid"><meta name="author" content="LemonGo97"><meta name="copyright" content="LemonGo97"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://blog.lemongo97.com/posts/6d9855d0/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><meta property="og:type" content="article"><meta property="og:title" content="Druid SQL解析工具的使用"><meta property="og:url" content="https://blog.lemongo97.com/posts/6d9855d0/"><meta property="og:site_name" content="LemonGo97のBlog"><meta property="og:description" content="前言最近在项目运行过程中，需要对标准SQL进行解析，然后对SQL进行改写，在各种查找对比后选中了Alibaba Druid来进行解析SQL（如非特制，以下均简称 Druid） Druid官方的wiki说的还算明白，但可惜的是没有相关API文档。 官方文档1. SQL Parser如需查看原文：SQL Parser 1. 简介SQL Parser是Druid的一个重要组成部分，Druid内置使用SQ"><meta property="og:image" content="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200804141920.png"><meta property="article:published_time" content="2020-08-03T02:57:58.000Z"><meta property="article:modified_time" content="2020-08-03T02:57:58.000Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-08-03 10:57:58'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="LemonGo97のBlog" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="https://coding-net-production-static-ci.codehub.cn/d70d0fa9-08d5-4fc7-ba82-7b73fee22292.jpg?imageMogr2/auto-orient/format/jpeg/cut/700x700x0x0" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">48</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">34</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="toc-number">2.</span> <span class="toc-text">官方文档</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-SQL-Parser"><span class="toc-number">2.1.</span> <span class="toc-text">1. SQL Parser</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.1.</span> <span class="toc-text">1. 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E5%92%8CAntlr%E7%94%9F%E6%88%90Parser%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">1.1. 和Antlr生成Parser的区别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Druid-SQL-Parser%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">1.2. Druid SQL Parser的使用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%90%84%E7%A7%8D%E8%AF%AD%E6%B3%95%E6%94%AF%E6%8C%81"><span class="toc-number">2.1.2.</span> <span class="toc-text">2. 各种语法支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%80%A7%E8%83%BD"><span class="toc-number">2.1.3.</span> <span class="toc-text">3. 性能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81%E7%9C%8B%E8%BF%99%E9%87%8C"><span class="toc-number">2.1.3.1.</span> <span class="toc-text">3.1. 测试代码看这里</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Druid-SQL-Parser%E7%9A%84%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84"><span class="toc-number">2.1.4.</span> <span class="toc-text">4. Druid SQL Parser的代码结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-parser"><span class="toc-number">2.1.4.1.</span> <span class="toc-text">4.1. parser</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-AST"><span class="toc-number">2.1.4.2.</span> <span class="toc-text">4.2. AST</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-Visitor"><span class="toc-number">2.1.4.3.</span> <span class="toc-text">4.3. Visitor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-%E8%87%AA%E5%AE%9A%E4%B9%89Visitor"><span class="toc-number">2.1.4.4.</span> <span class="toc-text">4.4. 自定义Visitor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-%E8%87%AA%E5%AE%9A%E4%B9%89visitor%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.1.4.5.</span> <span class="toc-text">4.5 自定义visitor示例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%B7%B1%E7%9A%84Visitor"><span class="toc-number">2.1.4.5.1.</span> <span class="toc-text">1. 实现自己的Visitor</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1-Oracle%E7%89%88%E6%9C%AC"><span class="toc-number">2.1.4.5.1.1.</span> <span class="toc-text">1.1 Oracle版本</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-MySql%E7%89%88%E6%9C%AC"><span class="toc-number">2.1.4.5.1.2.</span> <span class="toc-text">1.2 MySql版本</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-3-POSTGRESQL%E7%89%88%E6%9C%AC"><span class="toc-number">2.1.4.5.1.3.</span> <span class="toc-text">1.3 POSTGRESQL版本</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8Visitor"><span class="toc-number">2.1.4.5.2.</span> <span class="toc-text">2. 使用Visitor</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-%E6%96%B9%E8%A8%80"><span class="toc-number">2.1.4.6.</span> <span class="toc-text">4.6. 方言</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-SchemaRepository"><span class="toc-number">2.1.5.</span> <span class="toc-text">5. SchemaRepository</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-SQL%E7%BF%BB%E8%AF%91"><span class="toc-number">2.1.6.</span> <span class="toc-text">6. SQL翻译</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-SQL-Formatter"><span class="toc-number">2.2.</span> <span class="toc-text">2. SQL Formatter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E7%9A%84%E5%B7%A5%E5%85%B7%E7%B1%BBAPI"><span class="toc-number">2.2.1.</span> <span class="toc-text">格式化的工具类API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL-%E6%A0%BC%E5%BC%8F%E5%8C%96"><span class="toc-number">2.2.2.</span> <span class="toc-text">MySQL 格式化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-SQL-Schema-Repository"><span class="toc-number">2.3.</span> <span class="toc-text">3. SQL Schema Repository</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B-1"><span class="toc-number">2.3.1.</span> <span class="toc-text">1. 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8SchemaRepository"><span class="toc-number">2.3.2.</span> <span class="toc-text">2. 如何使用SchemaRepository</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Column-Resolve"><span class="toc-number">2.3.3.</span> <span class="toc-text">3. Column Resolve</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-SQL-Parser-Parameterize"><span class="toc-number">2.4.</span> <span class="toc-text">4. SQL Parser Parameterize</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.4.1.</span> <span class="toc-text">1. 功能介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-SQL%E5%8F%82%E6%95%B0%E5%8C%96"><span class="toc-number">2.4.2.</span> <span class="toc-text">2. SQL参数化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-SQL%E5%8F%82%E6%95%B0%E5%8C%96API"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">2.1 SQL参数化API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-SQL%E5%8F%82%E6%95%B0%E5%8C%96DEMO"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">2.2 SQL参数化DEMO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%8E%B7%E5%8F%96%E5%85%B7%E4%BD%93%E5%8F%82%E6%95%B0%E5%8C%96%E5%90%8E%E7%9A%84%E5%B8%B8%E9%87%8F%E5%80%BC"><span class="toc-number">2.4.2.3.</span> <span class="toc-text">3. 获取具体参数化后的常量值</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Druid-SQL-AST"><span class="toc-number">2.5.</span> <span class="toc-text">5. Druid SQL AST</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AFAST"><span class="toc-number">2.5.1.</span> <span class="toc-text">1. 什么是AST</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%9C%A8Druid-SQL-Parser%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9BAST%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.5.2.</span> <span class="toc-text">2. 在Druid SQL Parser中有哪些AST节点类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%B8%B8%E7%94%A8%E7%9A%84SQLExpr%E6%9C%89%E5%93%AA%E4%BA%9B"><span class="toc-number">2.5.2.1.</span> <span class="toc-text">2.1. 常用的SQLExpr有哪些</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%B8%B8%E7%94%A8%E7%9A%84SQLStatemment"><span class="toc-number">2.5.2.2.</span> <span class="toc-text">2.2. 常用的SQLStatemment</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-SQLTableSource"><span class="toc-number">2.5.2.3.</span> <span class="toc-text">2.3. SQLTableSource</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-SQLSelect-amp-SQLSelectQuery"><span class="toc-number">2.5.2.4.</span> <span class="toc-text">2.4. SQLSelect &amp; SQLSelectQuery</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-SQLCreateTableStatement"><span class="toc-number">2.5.2.5.</span> <span class="toc-text">2.5. SQLCreateTableStatement</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%80%8E%E6%A0%B7%E4%BA%A7%E7%94%9FAST"><span class="toc-number">2.5.3.</span> <span class="toc-text">3. 怎样产生AST</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E9%80%9A%E8%BF%87SQLUtils%E4%BA%A7%E7%94%9FList-lt-SQLStatement-gt"><span class="toc-number">2.5.3.1.</span> <span class="toc-text">3.1. 通过SQLUtils产生List&lt;SQLStatement&gt;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E9%80%9A%E8%BF%87SQLUtils%E4%BA%A7%E7%94%9FSQLExpr"><span class="toc-number">2.5.3.2.</span> <span class="toc-text">3.2. 通过SQLUtils产生SQLExpr</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%80%8E%E6%A0%B7%E6%89%93%E5%8D%B0AST%E8%8A%82%E7%82%B9"><span class="toc-number">2.5.4.</span> <span class="toc-text">4. 怎样打印AST节点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E9%80%9A%E8%BF%87SQLUtils%E5%B7%A5%E5%85%B7%E7%B1%BB%E6%89%93%E5%8D%B0%E8%8A%82%E7%82%B9"><span class="toc-number">2.5.4.1.</span> <span class="toc-text">4.1. 通过SQLUtils工具类打印节点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%A6%82%E4%BD%95%E8%87%AA%E5%AE%9A%E4%B9%89%E9%81%8D%E5%8E%86AST%E8%8A%82%E7%82%B9"><span class="toc-number">2.5.5.</span> <span class="toc-text">5. 如何自定义遍历AST节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%9B%B8%E5%85%B3%E9%98%85%E8%AF%BB"><span class="toc-number">2.5.6.</span> <span class="toc-text">6. 相关阅读</span></a></li></ol></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200804143628.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">LemonGo97のBlog</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Druid SQL解析工具的使用</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-08-03T02:57:58.000Z" title="发表于 2020-08-03 10:57:58">2020-08-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-08-03T02:57:58.000Z" title="更新于 2020-08-03 10:57:58">2020-08-03</time></span></div><div class="meta-secondline"> </div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近在项目运行过程中，需要对标准SQL进行解析，然后对SQL进行改写，在各种查找对比后选中了Alibaba Druid来进行解析SQL（如非特制，以下均简称 Druid）</p>
<p>Druid官方的wiki说的还算明白，但可惜的是没有相关API文档。</p>
<h1 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h1><h2 id="1-SQL-Parser"><a href="#1-SQL-Parser" class="headerlink" title="1. SQL Parser"></a>1. SQL Parser</h2><p>如需查看原文：<a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/SQL-Parser">SQL Parser</a></p>
<h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h3><p>SQL Parser是Druid的一个重要组成部分，Druid内置使用SQL Parser来实现防御SQL注入（<a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/%E7%AE%80%E4%BB%8B_WallFilter">WallFilter</a>）、合并统计没有参数化的SQL(<a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatFilter">StatFilter</a>的mergeSql)、<a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/SQL%E6%A0%BC%E5%BC%8F%E5%8C%96">SQL格式化</a>、分库分表。</p>
<h4 id="1-1-和Antlr生成Parser的区别"><a href="#1-1-和Antlr生成Parser的区别" class="headerlink" title="1.1. 和Antlr生成Parser的区别"></a>1.1. 和Antlr生成Parser的区别</h4><p>和Antlr生成的SQL有很大不同的是，Druid SQL Parser性能非常好，可以用于生产环境直接对SQL进行分析处理。</p>
<h4 id="1-2-Druid-SQL-Parser的使用场景"><a href="#1-2-Druid-SQL-Parser的使用场景" class="headerlink" title="1.2. Druid SQL Parser的使用场景"></a>1.2. Druid SQL Parser的使用场景</h4><ul>
<li>MySql SQL全量统计</li>
<li>Hive/<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/odps">ODPS</a> SQL执行安全审计</li>
<li>分库分表SQL解析引擎</li>
<li>数据库引擎的SQL Parser</li>
</ul>
<h3 id="2-各种语法支持"><a href="#2-各种语法支持" class="headerlink" title="2. 各种语法支持"></a>2. 各种语法支持</h3><p>Druid的sql parser是目前支持各种数据语法最完备的SQL Parser。目前对各种数据库的支持如下：</p>
<table>
<thead>
<tr>
<th>数据库</th>
<th>DML</th>
<th>DDL</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://www.aliyun.com/product/odps">odps</a></td>
<td>完全支持</td>
<td>完全支持</td>
</tr>
<tr>
<td>mysql</td>
<td>完全支持</td>
<td>完全支持</td>
</tr>
<tr>
<td>postgresql</td>
<td>完全支持</td>
<td>完全支持</td>
</tr>
<tr>
<td>oracle</td>
<td>支持大部分</td>
<td>支持大部分</td>
</tr>
<tr>
<td>sql server</td>
<td>支持常用的</td>
<td>支持常用的ddl</td>
</tr>
<tr>
<td>db2</td>
<td>支持常用的</td>
<td>支持常用的ddl</td>
</tr>
<tr>
<td>hive</td>
<td>支持常用的</td>
<td>支持常用的ddl</td>
</tr>
</tbody></table>
<p>druid还缺省支持sql-92标准的语法，所以也部分支持其他数据库的sql语法。</p>
<h3 id="3-性能"><a href="#3-性能" class="headerlink" title="3. 性能"></a>3. 性能</h3><p>Druid的SQL Parser是手工编写，性能非常好，目标就是在生产环境运行时使用的SQL Parser，性能比antlr、javacc之类工具生成的Parser快10倍甚至100倍以上。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ID, NAME, AGE <span class="keyword">FROM</span> <span class="keyword">USER</span> <span class="keyword">WHERE</span> ID <span class="operator">=</span> ?</span><br></pre></td></tr></table></figure>

<p>这样的SQL，druid parser处理大约是600纳秒，也就是说单线程每秒可以处理1500万次以上。在1.1.3~1.1.4版本中，SQL Parser的性能有极大提升，完全可以适用于生产环境中对SQL进行处理。</p>
<h4 id="3-1-测试代码看这里"><a href="#3-1-测试代码看这里" class="headerlink" title="3.1. 测试代码看这里"></a>3.1. 测试代码看这里</h4><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/blob/master/src/test/java/com/alibaba/druid/benckmark/sql/MySqlPerfTest.java">MySqlPerfTest.java</a></p>
<h3 id="4-Druid-SQL-Parser的代码结构"><a href="#4-Druid-SQL-Parser的代码结构" class="headerlink" title="4. Druid SQL Parser的代码结构"></a>4. Druid SQL Parser的代码结构</h3><p>Druid SQL Parser分三个模块：</p>
<ul>
<li>Parser</li>
<li>AST</li>
<li>Visitor</li>
</ul>
<h4 id="4-1-parser"><a href="#4-1-parser" class="headerlink" title="4.1. parser"></a>4.1. parser</h4><p>parser是将输入文本转换为ast（抽象语法树），parser有包括两个部分，Parser和Lexer，其中Lexer实现词法分析，Parser实现语法分析。</p>
<h4 id="4-2-AST"><a href="#4-2-AST" class="headerlink" title="4.2. AST"></a>4.2. AST</h4><p>AST是Abstract Syntax Tree的缩写，也就是抽象语法树。AST是parser输出的结果。下面是获得抽象语法树的一个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">dbType</span> <span class="operator">=</span> JdbcConstants.MYSQL; <span class="comment">// 可以是ORACLE、POSTGRESQL、SQLSERVER、ODPS等</span></span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from t&quot;</span>;</span><br><span class="line">List&lt;SQLStatement&gt; stmtList = SQLUtils.parseStatements(sql, dbType);</span><br></pre></td></tr></table></figure>

<ul>
<li>Druid SQL AST介绍 <a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/Druid_SQL_AST">https://github.com/alibaba/druid/wiki/Druid_SQL_AST</a></li>
</ul>
<h4 id="4-3-Visitor"><a href="#4-3-Visitor" class="headerlink" title="4.3. Visitor"></a>4.3. Visitor</h4><p>Visitor是遍历AST的手段，是处理AST最方便的模式，Visitor是一个接口，有缺省什么都没做的实现VistorAdapter。</p>
<p>我们可以实现不同的Visitor来满足不同的需求，Druid内置提供了如下Visitor: </p>
<ul>
<li>OutputVisitor用来把AST输出为字符串</li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/%E7%AE%80%E4%BB%8B_WallFilter">WallVisitor</a> 来分析SQL语意来防御SQL注入攻击</li>
<li>ParameterizedOutputVisitor用来合并未参数化的SQL进行统计</li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/EvalVisitor">EvalVisitor</a> 用来对SQL表达式求值</li>
<li>ExportParameterVisitor用来提取SQL中的变量参数</li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/SchemaStatVisitor">SchemaStatVisitor</a> 用来统计SQL中使用的表、字段、过滤条件、排序表达式、分组表达式</li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/SQL_Format">SQL格式化</a> Druid内置了基于语义的SQL格式化功能</li>
</ul>
<h4 id="4-4-自定义Visitor"><a href="#4-4-自定义Visitor" class="headerlink" title="4.4. 自定义Visitor"></a>4.4. 自定义Visitor</h4><p>每种方言的Visitor都有一个缺省的VisitorAdapter，使得编写自定义的Visitor更方便。<br><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/SQL_Parser_Demo_visitor">https://github.com/alibaba/druid/wiki/SQL_Parser_Demo_visitor</a></p>
<h4 id="4-5-自定义visitor示例"><a href="#4-5-自定义visitor示例" class="headerlink" title="4.5 自定义visitor示例"></a>4.5 自定义visitor示例</h4><h5 id="1-实现自己的Visitor"><a href="#1-实现自己的Visitor" class="headerlink" title="1. 实现自己的Visitor"></a>1. 实现自己的Visitor</h5><h6 id="1-1-Oracle版本"><a href="#1-1-Oracle版本" class="headerlink" title="1.1 Oracle版本"></a>1.1 Oracle版本</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ExportTableAliasVisitor</span> <span class="keyword">extends</span> <span class="title class_">OracleASTVisitorAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, SQLTableSource&gt; aliasMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, SQLTableSource&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">visit</span><span class="params">(OracleSelectTableReference x)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">alias</span> <span class="operator">=</span> x.getAlias();</span><br><span class="line">        aliasMap.put(alias, x);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, SQLTableSource&gt; <span class="title function_">getAliasMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> aliasMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="1-2-MySql版本"><a href="#1-2-MySql版本" class="headerlink" title="1.2 MySql版本"></a>1.2 MySql版本</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ExportTableAliasVisitor</span> <span class="keyword">extends</span> <span class="title class_">MySqlASTVisitorAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, SQLTableSource&gt; aliasMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, SQLTableSource&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">visit</span><span class="params">(SQLExprTableSource x)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">alias</span> <span class="operator">=</span> x.getAlias();</span><br><span class="line">        aliasMap.put(alias, x);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, SQLTableSource&gt; <span class="title function_">getAliasMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> aliasMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h6 id="1-3-POSTGRESQL版本"><a href="#1-3-POSTGRESQL版本" class="headerlink" title="1.3 POSTGRESQL版本"></a>1.3 POSTGRESQL版本</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ExportTableAliasVisitor</span> <span class="keyword">extends</span> <span class="title class_">PGASTVisitorAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, SQLTableSource&gt; aliasMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, SQLTableSource&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">visit</span><span class="params">(SQLExprTableSource x)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">alias</span> <span class="operator">=</span> x.getAlias();</span><br><span class="line">        aliasMap.put(alias, x);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, SQLTableSource&gt; <span class="title function_">getAliasMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> aliasMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-使用Visitor"><a href="#2-使用Visitor" class="headerlink" title="2. 使用Visitor"></a>2. 使用Visitor</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">finnal <span class="type">String</span> <span class="variable">dbType</span> <span class="operator">=</span> JdbcConstants.ORACLE; <span class="comment">// JdbcConstants.MYSQL或者JdbcConstants.POSTGRESQL</span></span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from mytable a where a.id = 3&quot;</span>;</span><br><span class="line">List&lt;SQLStatement&gt; stmtList = SQLUtils.parseStatements(sql, dbType);</span><br><span class="line"></span><br><span class="line"><span class="type">ExportTableAliasVisitor</span> <span class="variable">visitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExportTableAliasVisitor</span>();</span><br><span class="line"><span class="keyword">for</span> (SQLStatement stmt : stmtList) &#123;</span><br><span class="line">    stmt.accept(visitor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">SQLTableSource</span> <span class="variable">tableSource</span> <span class="operator">=</span> visitor.getAliasMap().get(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">System.out.println(tableSource);</span><br></pre></td></tr></table></figure>

<h4 id="4-6-方言"><a href="#4-6-方言" class="headerlink" title="4.6. 方言"></a>4.6. 方言</h4><p>SQL-92、SQL-99等都是标准SQL，mysql/oracle/pg/sqlserver/odps等都是方言，也就是dialect。parser/ast/visitor都需要针对不同的方言进行特别处理。</p>
<h3 id="5-SchemaRepository"><a href="#5-SchemaRepository" class="headerlink" title="5. SchemaRepository"></a>5. SchemaRepository</h3><p>Druid SQL Parser内置了一个SchemaRepository，在内存中缓存SQL Schema信息，用于SQL语义解析中的ColumnResolve等操作。<br><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/SQL_Schema_Repository">https://github.com/alibaba/druid/wiki/SQL_Schema_Repository</a></p>
<h3 id="6-SQL翻译"><a href="#6-SQL翻译" class="headerlink" title="6. SQL翻译"></a>6. SQL翻译</h3><p>可以基于Druid SQL Parser之上构造Oracle SQL到其他数据的SQL翻译。比如Aliyun提供的Oracle到MySql的<a target="_blank" rel="noopener" href="https://rainbow-expert.aliyun.com/sqltransform.htm">SQL翻译功能</a>，就是基于Druid基础上实现的。<a target="_blank" rel="noopener" href="https://rainbow-expert.aliyun.com/sqltransform.htm">https://rainbow-expert.aliyun.com/sqltransform.htm</a></p>
<h2 id="2-SQL-Formatter"><a href="#2-SQL-Formatter" class="headerlink" title="2. SQL Formatter"></a>2. SQL Formatter</h2><p>Druid SQL Parser提供了格式化代码的工具类。这个是基于语义分析做的SQL格式化功能，比其他的SQL格式化做的更智能，效果更好。</p>
<h3 id="格式化的工具类API"><a href="#格式化的工具类API" class="headerlink" title="格式化的工具类API"></a>格式化的工具类API</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.druid.sql;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLUtils</span> &#123;</span><br><span class="line">    String <span class="title function_">format</span><span class="params">(String sq, String dbType)</span>;</span><br><span class="line">    String <span class="title function_">format</span><span class="params">(String sq, String dbType, FormatOption option)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其中dbType支持mysql/postgresql/odps/oracle/db2/sqlserver</li>
<li>option缺省有SQLUtils.DEFAULT_FORMAT_OPTION（大写）、SQLUtils.DEFAULT_LCASE_FORMAT_OPTION（小写）两种可以选择，也可按需要定制化。</li>
</ul>
<h3 id="MySQL-格式化"><a href="#MySQL-格式化" class="headerlink" title="MySQL 格式化"></a>MySQL 格式化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.druid.sql.SQLUtils;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.util.JdbcConstants;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update t set name = &#x27;x&#x27; where id &lt; 100 limit 10&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> SQLUtils.format(sql, JdbcConstants.MYSQL);</span><br><span class="line">System.out.println(result); <span class="comment">// 缺省大写格式</span></span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">result_lcase</span> <span class="operator">=</span> SQLUtils.format(sql</span><br><span class="line">                         , JdbcConstants.MYSQL</span><br><span class="line">                         , SQLUtils.DEFAULT_LCASE_FORMAT_OPTION);</span><br><span class="line">System.out.println(result_lcase); <span class="comment">// 小写格式</span></span><br></pre></td></tr></table></figure>
<p>输出格式化后的结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 这是缺省的大写格式</span></span><br><span class="line"><span class="keyword">UPDATE</span> t</span><br><span class="line"><span class="keyword">SET</span> name <span class="operator">=</span> <span class="string">&#x27;x&#x27;</span></span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">&lt;</span> <span class="number">100</span></span><br><span class="line">LIMIT <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 这是小写格式</span></span><br><span class="line"><span class="keyword">update</span> t</span><br><span class="line"><span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;x&#x27;</span></span><br><span class="line"><span class="keyword">where</span> id <span class="operator">&lt;</span> <span class="number">100</span></span><br><span class="line">limit <span class="number">10</span></span><br></pre></td></tr></table></figure>

<h2 id="3-SQL-Schema-Repository"><a href="#3-SQL-Schema-Repository" class="headerlink" title="3. SQL Schema Repository"></a>3. SQL Schema Repository</h2><h3 id="1-简介-1"><a href="#1-简介-1" class="headerlink" title="1. 简介"></a>1. 简介</h3><p>Druid SQL Parser内置了一个SchemaRepository，在内存中缓存SQL Schema信息，用于SQL语义解析中的ColumnResolve等操作。</p>
<h3 id="2-如何使用SchemaRepository"><a href="#2-如何使用SchemaRepository" class="headerlink" title="2. 如何使用SchemaRepository"></a>2. 如何使用SchemaRepository</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.druid.sql.repository.SchemaRepository;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SchemaRepository是和数据库类型相关的，构造时需要传入dbType</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">dbType</span> <span class="operator">=</span> JdbcConstants.MYSQL;</span><br><span class="line"><span class="type">SchemaRepository</span> <span class="variable">repository</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SchemaRepository</span>(dbType);</span><br><span class="line"></span><br><span class="line">repository.console(<span class="string">&quot;use sc00;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;CREATE TABLE `test1` (\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_tinyint` tinyint(4) DEFAULT &#x27;1&#x27; COMMENT &#x27;tinyint&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_smallint` smallint(6) DEFAULT 0 COMMENT &#x27;smallint&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_mediumint` mediumint(9) DEFAULT NULL COMMENT &#x27;mediumint&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_int` int(11) DEFAULT NULL COMMENT &#x27;int&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_bigint` bigint(20) DEFAULT NULL COMMENT &#x27;bigint&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_decimal` decimal(10,3) DEFAULT NULL COMMENT &#x27;decimal&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_date` date DEFAULT &#x27;0000-00-00&#x27; COMMENT &#x27;date&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_datetime` datetime DEFAULT &#x27;0000-00-00 00:00:00&#x27; COMMENT &#x27;datetime&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_timestamp` timestamp NULL DEFAULT NULL COMMENT &#x27;timestamp&#x27;  ON UPDATE CURRENT_TIMESTAMP ,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_time` time DEFAULT NULL COMMENT &#x27;time&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_char` char(10) DEFAULT NULL COMMENT &#x27;char&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_varchar` varchar(10) DEFAULT &#x27;hello&#x27; COMMENT &#x27;varchar&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_blob` blob COMMENT &#x27;blob&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_text` text COMMENT &#x27;text&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_mediumtext` mediumtext COMMENT &#x27;mediumtext&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  `c_longblob` longblob COMMENT &#x27;longblob&#x27;,\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  PRIMARY KEY (`id`,`c_tinyint`),\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  UNIQUE KEY `uk_a` (`c_varchar`,`c_mediumint`),\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  KEY `k_c` (`c_tinyint`,`c_int`),\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  KEY `k_d` (`c_char`,`c_bigint`)\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;) ENGINE=InnoDB AUTO_INCREMENT=1769503 DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;10000000&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line">repository.console(sql);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在如下的代码中可以知道repository中已经存在表test1</span></span><br><span class="line"><span class="type">MySqlCreateTableStatement</span> <span class="variable">createTableStmt</span> <span class="operator">=</span> (MySqlCreateTableStatement) repository.findTable(<span class="string">&quot;test1&quot;</span>).getStatement();</span><br><span class="line">assertEquals(<span class="number">21</span>, createTableStmt.getTableElementList().size());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过执行命令&quot;show columns from test1&quot;可以获得mysql console风格的输出</span></span><br><span class="line">assertEquals(<span class="string">&quot;+--------------+---------------+------+-----+---------------------+-----------------------------+\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| Field        | Type          | Null | Key | Default             | Extra                       |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;+--------------+---------------+------+-----+---------------------+-----------------------------+\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| id           | bigint(20)    | NO   | PRI | NULL                | auto_increment              |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_tinyint    | tinyint(4)    | YES  | PRI | 1                   |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_smallint   | smallint(6)   | YES  |     | 0                   |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_mediumint  | mediumint(9)  | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_int        | int(11)       | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_bigint     | bigint(20)    | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_decimal    | decimal(10,3) | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_date       | date          | YES  |     | 0000-00-00          |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_datetime   | datetime      | YES  |     | 0000-00-00 00:00:00 |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_timestamp  | timestamp     | YES  |     | NULL                | on update CURRENT_TIMESTAMP |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_time       | time          | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_char       | char(10)      | YES  | MUL | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_varchar    | varchar(10)   | YES  | MUL | hello               |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_blob       | blob          | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_text       | text          | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_mediumtext | mediumtext    | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_longblob   | longblob      | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;+--------------+---------------+------+-----+---------------------+-----------------------------+\n&quot;</span>, </span><br><span class="line">repository.console(<span class="string">&quot;show columns from test1&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行alter语句，修改repository中内容</span></span><br><span class="line">repository.console(<span class="string">&quot;alter table test1 drop column c_decimal;&quot;</span>);</span><br><span class="line">assertEquals(<span class="number">20</span>, createTableStmt.getTableElementList().size());</span><br><span class="line"></span><br><span class="line">assertEquals(<span class="string">&quot;+--------------+--------------+------+-----+---------------------+-----------------------------+\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| Field        | Type         | Null | Key | Default             | Extra                       |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;+--------------+--------------+------+-----+---------------------+-----------------------------+\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| id           | bigint(20)   | NO   | PRI | NULL                | auto_increment              |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_tinyint    | tinyint(4)   | YES  | PRI | 1                   |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_smallint   | smallint(6)  | YES  |     | 0                   |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_mediumint  | mediumint(9) | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_int        | int(11)      | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_bigint     | bigint(20)   | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_date       | date         | YES  |     | 0000-00-00          |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_datetime   | datetime     | YES  |     | 0000-00-00 00:00:00 |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_timestamp  | timestamp    | YES  |     | NULL                | on update CURRENT_TIMESTAMP |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_time       | time         | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_char       | char(10)     | YES  | MUL | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_varchar    | varchar(10)  | YES  | MUL | hello               |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_blob       | blob         | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_text       | text         | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_mediumtext | mediumtext   | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;| c_longblob   | longblob     | YES  |     | NULL                |                             |\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;+--------------+--------------+------+-----+---------------------+-----------------------------+\n&quot;</span>, </span><br><span class="line">repository.console(<span class="string">&quot;show columns from test1&quot;</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-Column-Resolve"><a href="#3-Column-Resolve" class="headerlink" title="3. Column Resolve"></a>3. Column Resolve</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">dbType</span> <span class="operator">=</span> JdbcConstants.MYSQL;</span><br><span class="line"></span><br><span class="line"><span class="type">SchemaRepository</span> <span class="variable">repository</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SchemaRepository</span>(dbType);</span><br><span class="line"></span><br><span class="line">repository.console(<span class="string">&quot;create table t_emp(emp_id bigint, name varchar(20));&quot;</span>);</span><br><span class="line">repository.console(<span class="string">&quot;create table t_org(org_id bigint, name varchar(20));&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT emp_id, a.name AS emp_name, org_id, b.name AS org_name\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;FROM t_emp a\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;\tINNER JOIN t_org b ON a.emp_id = b.org_id&quot;</span>;</span><br><span class="line"></span><br><span class="line">List&lt;SQLStatement&gt; stmtList = SQLUtils.parseStatements(sql, dbType);</span><br><span class="line">assertEquals(<span class="number">1</span>, stmtList.size());</span><br><span class="line"></span><br><span class="line"><span class="type">SQLSelectStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> (SQLSelectStatement) stmtList.get(<span class="number">0</span>);</span><br><span class="line"><span class="type">SQLSelectQueryBlock</span> <span class="variable">queryBlock</span> <span class="operator">=</span> stmt.getSelect().getQueryBlock();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 大小写不敏感</span></span><br><span class="line">assertNotNull(queryBlock.findTableSource(<span class="string">&quot;A&quot;</span>));</span><br><span class="line">assertSame(queryBlock.findTableSource(<span class="string">&quot;a&quot;</span>), queryBlock.findTableSource(<span class="string">&quot;A&quot;</span>));</span><br><span class="line"></span><br><span class="line">assertNull(queryBlock.findTableSourceWithColumn(<span class="string">&quot;emp_id&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用repository做column resolve</span></span><br><span class="line">repository.resolve(stmt);</span><br><span class="line"></span><br><span class="line">assertNotNull(queryBlock.findTableSourceWithColumn(<span class="string">&quot;emp_id&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="type">SQLExprTableSource</span> <span class="variable">tableSource</span> <span class="operator">=</span> (SQLExprTableSource) queryBlock.findTableSourceWithColumn(<span class="string">&quot;emp_id&quot;</span>);</span><br><span class="line">assertNotNull(tableSource.getSchemaObject());</span><br><span class="line"></span><br><span class="line"><span class="type">SQLCreateTableStatement</span> <span class="variable">createTableStmt</span> <span class="operator">=</span> (SQLCreateTableStatement) tableSource.getSchemaObject().getStatement();</span><br><span class="line">assertNotNull(createTableStmt);</span><br><span class="line"></span><br><span class="line"><span class="type">SQLSelectItem</span> <span class="variable">selectItem</span> <span class="operator">=</span> queryBlock.findSelectItem(<span class="string">&quot;org_name&quot;</span>);</span><br><span class="line">assertNotNull(selectItem);</span><br><span class="line"><span class="type">SQLPropertyExpr</span> <span class="variable">selectItemExpr</span> <span class="operator">=</span> (SQLPropertyExpr) selectItem.getExpr();</span><br><span class="line"><span class="type">SQLColumnDefinition</span> <span class="variable">column</span> <span class="operator">=</span> selectItemExpr.getResolvedColumn();</span><br><span class="line">assertNotNull(column);</span><br><span class="line">assertEquals(<span class="string">&quot;name&quot;</span>, column.getName().toString());</span><br><span class="line">assertEquals(<span class="string">&quot;t_org&quot;</span>, (((SQLCreateTableStatement)column.getParent()).getName().toString()));</span><br><span class="line"></span><br><span class="line">assertSame(queryBlock.findTableSource(<span class="string">&quot;B&quot;</span>), selectItemExpr.getResolvedTableSource());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="4-SQL-Parser-Parameterize"><a href="#4-SQL-Parser-Parameterize" class="headerlink" title="4. SQL Parser Parameterize"></a>4. SQL Parser Parameterize</h2><h3 id="1-功能介绍"><a href="#1-功能介绍" class="headerlink" title="1. 功能介绍"></a>1. 功能介绍</h3><p>如果要对SQL做各种统计，通常需要对SQL进行参数化再做统计。比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span> 原始<span class="keyword">SQL</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 参数化<span class="keyword">SQL</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t <span class="keyword">where</span> id <span class="operator">=</span> ?</span><br></pre></td></tr></table></figure>

<h3 id="2-SQL参数化"><a href="#2-SQL参数化" class="headerlink" title="2. SQL参数化"></a>2. SQL参数化</h3><h4 id="2-1-SQL参数化API"><a href="#2-1-SQL参数化API" class="headerlink" title="2.1 SQL参数化API"></a>2.1 SQL参数化API</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.druid.sql.visitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParameterizedOutputVisitorUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">parameterize</span><span class="params">(String sql, String dbType)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-SQL参数化DEMO"><a href="#2-2-SQL参数化DEMO" class="headerlink" title="2.2 SQL参数化DEMO"></a>2.2 SQL参数化DEMO</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.druid.sql.visitor.ParameterizedOutputVisitorUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">dbType</span> <span class="operator">=</span> JdbcConstants.MYSQL;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from t where id = 1 or id = 2 or id = 3&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">psql</span> <span class="operator">=</span> ParameterizedOutputVisitorUtils.parameterize(sql, dbType);</span><br><span class="line">assertEquals(<span class="string">&quot;SELECT *\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;FROM t\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;WHERE id = ?&quot;</span>, psql);</span><br></pre></td></tr></table></figure>

<h4 id="3-获取具体参数化后的常量值"><a href="#3-获取具体参数化后的常量值" class="headerlink" title="3. 获取具体参数化后的常量值"></a>3. 获取具体参数化后的常量值</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">dbType</span> <span class="operator">=</span> JdbcConstants.MYSQL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数化SQL是输出的参数保存在这个List中</span></span><br><span class="line">List&lt;Object&gt; outParameters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object&gt;();</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from t where id = 101 and age = 102 or name = &#x27;wenshao&#x27;&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">psql</span> <span class="operator">=</span> ParameterizedOutputVisitorUtils.parameterize(sql, dbType, outParameters);</span><br><span class="line">assertEquals(<span class="string">&quot;SELECT *\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;FROM t\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;WHERE id = ?\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;\tAND age = ?\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;\tOR name = ?&quot;</span>, psql);</span><br><span class="line"></span><br><span class="line">assertEquals(<span class="number">3</span>, outParameters.size());</span><br><span class="line">assertEquals(<span class="number">101</span>, outParameters.get(<span class="number">0</span>));</span><br><span class="line">assertEquals(<span class="number">102</span>, outParameters.get(<span class="number">1</span>));</span><br><span class="line">assertEquals(<span class="string">&quot;wenshao&quot;</span>, outParameters.get(<span class="number">2</span>));</span><br></pre></td></tr></table></figure>



<h2 id="5-Druid-SQL-AST"><a href="#5-Druid-SQL-AST" class="headerlink" title="5. Druid SQL AST"></a>5. Druid SQL AST</h2><h3 id="1-什么是AST"><a href="#1-什么是AST" class="headerlink" title="1. 什么是AST"></a>1. 什么是AST</h3><p>AST是abstract syntax tree的缩写，也就是抽象语法树。和所有的Parser一样，Druid Parser会生成一个抽象语法树。</p>
<h3 id="2-在Druid-SQL-Parser中有哪些AST节点类型"><a href="#2-在Druid-SQL-Parser中有哪些AST节点类型" class="headerlink" title="2. 在Druid SQL Parser中有哪些AST节点类型"></a>2. 在Druid SQL Parser中有哪些AST节点类型</h3><p>在Druid中，AST节点类型主要包括SQLObject、SQLExpr、SQLStatement三种抽象类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.druid.sql.ast;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">SQLObject</span> &#123;&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">SQLExpr</span> <span class="keyword">extends</span> <span class="title class_">SQLObject</span> &#123;&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">SQLStatement</span> <span class="keyword">extends</span> <span class="title class_">SQLObject</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">SQLTableSource</span> <span class="keyword">extends</span> <span class="title class_">SQLObject</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLSelect</span> <span class="keyword">extends</span> <span class="title class_">SQLObject</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLSelectQueryBlock</span> <span class="keyword">extends</span> <span class="title class_">SQLObject</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-1-常用的SQLExpr有哪些"><a href="#2-1-常用的SQLExpr有哪些" class="headerlink" title="2.1. 常用的SQLExpr有哪些"></a>2.1. 常用的SQLExpr有哪些</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.druid.sql.ast.expr;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SQLName是一种的SQLExpr的Expr，包括SQLIdentifierExpr、SQLPropertyExpr等</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SQLName</span> <span class="keyword">extends</span> <span class="title class_">SQLExpr</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 例如 ID = 3 这里的ID是一个SQLIdentifierExpr</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLIdentifierExpr</span> <span class="keyword">implements</span> <span class="title class_">SQLExpr</span>, SQLName &#123;</span><br><span class="line">    String name;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 例如 A.ID = 3 这里的A.ID是一个SQLPropertyExpr</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLPropertyExpr</span> <span class="keyword">implements</span> <span class="title class_">SQLExpr</span>, SQLName &#123;</span><br><span class="line">    SQLExpr owner;</span><br><span class="line">    String name;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 例如 ID = 3 这是一个SQLBinaryOpExpr</span></span><br><span class="line"><span class="comment">// left是ID (SQLIdentifierExpr)</span></span><br><span class="line"><span class="comment">// right是3 (SQLIntegerExpr)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLBinaryOpExpr</span> <span class="keyword">implements</span> <span class="title class_">SQLExpr</span> &#123;</span><br><span class="line">    SQLExpr left;</span><br><span class="line">    SQLExpr right;</span><br><span class="line">    SQLBinaryOperator operator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 例如 select * from where id = ?，这里的?是一个SQLVariantRefExpr，name是&#x27;?&#x27;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLVariantRefExpr</span> <span class="keyword">extends</span> <span class="title class_">SQLExprImpl</span> &#123; </span><br><span class="line">    String name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 例如 ID = 3 这里的3是一个SQLIntegerExpr</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLIntegerExpr</span> <span class="keyword">extends</span> <span class="title class_">SQLNumericLiteralExpr</span> <span class="keyword">implements</span> <span class="title class_">SQLValuableExpr</span> &#123; </span><br><span class="line">    Number number;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 所有实现了SQLValuableExpr接口的SQLExpr都可以直接调用这个方法求值</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.number;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 例如 NAME = &#x27;jobs&#x27; 这里的&#x27;jobs&#x27;是一个SQLCharExpr</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLCharExpr</span> <span class="keyword">extends</span> <span class="title class_">SQLTextLiteralExpr</span> <span class="keyword">implements</span> <span class="title class_">SQLValuableExpr</span>&#123;</span><br><span class="line">    String text;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-常用的SQLStatemment"><a href="#2-2-常用的SQLStatemment" class="headerlink" title="2.2. 常用的SQLStatemment"></a>2.2. 常用的SQLStatemment</h4><p>最常用的Statement当然是SELECT/UPDATE/DELETE/INSERT，他们分别是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.druid.sql.ast.statement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLSelectStatement</span> <span class="keyword">implements</span> <span class="title class_">SQLStatement</span> &#123;</span><br><span class="line">    SQLSelect select;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLUpdateStatement</span> <span class="keyword">implements</span> <span class="title class_">SQLStatement</span> &#123;</span><br><span class="line">    SQLExprTableSource tableSource;</span><br><span class="line">     List&lt;SQLUpdateSetItem&gt; items;</span><br><span class="line">     SQLExpr where;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLDeleteStatement</span> <span class="keyword">implements</span> <span class="title class_">SQLStatement</span> &#123;</span><br><span class="line">    SQLTableSource tableSource; </span><br><span class="line">    SQLExpr where;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLInsertStatement</span> <span class="keyword">implements</span> <span class="title class_">SQLStatement</span> &#123;</span><br><span class="line">    SQLExprTableSource tableSource;</span><br><span class="line">    List&lt;SQLExpr&gt; columns;</span><br><span class="line">    SQLSelect query;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-SQLTableSource"><a href="#2-3-SQLTableSource" class="headerlink" title="2.3. SQLTableSource"></a>2.3. SQLTableSource</h4><p>常见的SQLTableSource包括SQLExprTableSource、SQLJoinTableSource、SQLSubqueryTableSource、SQLWithSubqueryClause.Entry</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SQLTableSourceImpl</span> <span class="keyword">extends</span> <span class="title class_">SQLObjectImpl</span> <span class="keyword">implements</span> <span class="title class_">SQLTableSource</span> &#123; </span><br><span class="line">    String alias;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 例如 select * from emp where i = 3，这里的from emp是一个SQLExprTableSource</span></span><br><span class="line"><span class="comment">// 其中expr是一个name=emp的SQLIdentifierExpr</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLExprTableSource</span> <span class="keyword">extends</span> <span class="title class_">SQLTableSourceImpl</span> &#123;</span><br><span class="line">    SQLExpr expr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 例如 select * from emp e inner join org o on e.org_id = o.id</span></span><br><span class="line"><span class="comment">// 其中left &#x27;emp e&#x27; 是一个SQLExprTableSource，right &#x27;org o&#x27;也是一个SQLExprTableSource</span></span><br><span class="line"><span class="comment">// condition &#x27;e.org_id = o.id&#x27;是一个SQLBinaryOpExpr</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLJoinTableSource</span> <span class="keyword">extends</span> <span class="title class_">SQLTableSourceImpl</span> &#123;</span><br><span class="line">    SQLTableSource left;</span><br><span class="line">    SQLTableSource right;</span><br><span class="line">    JoinType joinType; <span class="comment">// INNER_JOIN/CROSS_JOIN/LEFT_OUTER_JOIN/RIGHT_OUTER_JOIN/...</span></span><br><span class="line">    SQLExpr condition;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 例如 select * from (select * from temp) a，这里第一层from(...)是一个SQLSubqueryTableSource</span></span><br><span class="line">SQLSubqueryTableSource <span class="keyword">extends</span> <span class="title class_">SQLTableSourceImpl</span> &#123;</span><br><span class="line">    SQLSelect select;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">例如</span></span><br><span class="line"><span class="comment">WITH RECURSIVE ancestors AS (</span></span><br><span class="line"><span class="comment">    SELECT *</span></span><br><span class="line"><span class="comment">    FROM org</span></span><br><span class="line"><span class="comment">    UNION</span></span><br><span class="line"><span class="comment">    SELECT f.*</span></span><br><span class="line"><span class="comment">    FROM org f, ancestors a</span></span><br><span class="line"><span class="comment">    WHERE f.id = a.parent_id</span></span><br><span class="line"><span class="comment">)</span></span><br><span class="line"><span class="comment">SELECT *</span></span><br><span class="line"><span class="comment">FROM ancestors;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">这里的ancestors AS (...) 是一个SQLWithSubqueryClause.Entry</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLWithSubqueryClause</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> <span class="keyword">extends</span> <span class="title class_">SQLTableSourceImpl</span> &#123; </span><br><span class="line">         SQLSelect subQuery;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-SQLSelect-amp-SQLSelectQuery"><a href="#2-4-SQLSelect-amp-SQLSelectQuery" class="headerlink" title="2.4. SQLSelect &amp; SQLSelectQuery"></a>2.4. SQLSelect &amp; SQLSelectQuery</h4><p>SQLSelectStatement包含一个SQLSelect，SQLSelect包含一个SQLSelectQuery，都是组成的关系。SQLSelectQuery有主要的两个派生类，分别是SQLSelectQueryBlock和SQLUnionQuery。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SQLSelect</span> <span class="keyword">extends</span> <span class="title class_">SQLObjectImpl</span> &#123; </span><br><span class="line">    SQLWithSubqueryClause withSubQuery;</span><br><span class="line">    SQLSelectQuery query;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">SQLSelectQuery</span> <span class="keyword">extends</span> <span class="title class_">SQLObject</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLSelectQueryBlock</span> <span class="keyword">implements</span> <span class="title class_">SQLSelectQuery</span> &#123;</span><br><span class="line">    List&lt;SQLSelectItem&gt; selectList;</span><br><span class="line">    SQLTableSource from;</span><br><span class="line">    SQLExprTableSource into;</span><br><span class="line">    SQLExpr where;</span><br><span class="line">    SQLSelectGroupByClause groupBy;</span><br><span class="line">    SQLOrderBy orderBy;</span><br><span class="line">    SQLLimit limit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SQLUnionQuery</span> <span class="keyword">implements</span> <span class="title class_">SQLSelectQuery</span> &#123;</span><br><span class="line">    SQLSelectQuery left;</span><br><span class="line">    SQLSelectQuery right;</span><br><span class="line">    SQLUnionOperator operator; <span class="comment">// UNION/UNION_ALL/MINUS/INTERSECT</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-5-SQLCreateTableStatement"><a href="#2-5-SQLCreateTableStatement" class="headerlink" title="2.5. SQLCreateTableStatement"></a>2.5. SQLCreateTableStatement</h4><p>建表语句包含了一系列方法，用于方便各种操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLCreateTableStatement</span> <span class="keyword">extends</span> <span class="title class_">SQLStatementImpl</span> <span class="keyword">implements</span> <span class="title class_">SQLDDLStatement</span>, SQLCreateStatement &#123;</span><br><span class="line">    SQLExprTableSource tableSource;</span><br><span class="line">    List&lt;SQLTableElement&gt; tableElementList;</span><br><span class="line">    Select select;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 忽略大小写的查找SQLCreateTableStatement中的SQLColumnDefinition</span></span><br><span class="line">    <span class="keyword">public</span> SQLColumnDefinition <span class="title function_">findColumn</span><span class="params">(String columName)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 忽略大小写的查找SQLCreateTableStatement中的column关联的索引</span></span><br><span class="line">    <span class="keyword">public</span> SQLTableElement <span class="title function_">findIndex</span><span class="params">(String columnName)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否外键依赖另外一个表</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isReferenced</span><span class="params">(String tableName)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-怎样产生AST"><a href="#3-怎样产生AST" class="headerlink" title="3. 怎样产生AST"></a>3. 怎样产生AST</h3><h4 id="3-1-通过SQLUtils产生List-lt-SQLStatement-gt"><a href="#3-1-通过SQLUtils产生List-lt-SQLStatement-gt" class="headerlink" title="3.1. 通过SQLUtils产生List&lt;SQLStatement&gt;"></a>3.1. 通过SQLUtils产生List&lt;SQLStatement&gt;</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.druid.util.JdbcConstants;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">dbType</span> <span class="operator">=</span> JdbcConstants.MYSQL;</span><br><span class="line">List&lt;SQLStatement&gt; statementList = SQLUtils.parseStatements(sql, dbType);</span><br></pre></td></tr></table></figure>

<h4 id="3-2-通过SQLUtils产生SQLExpr"><a href="#3-2-通过SQLUtils产生SQLExpr" class="headerlink" title="3.2. 通过SQLUtils产生SQLExpr"></a>3.2. 通过SQLUtils产生SQLExpr</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">dbType</span> <span class="operator">=</span> JdbcConstants.MYSQL;</span><br><span class="line"><span class="type">SQLExpr</span> <span class="variable">expr</span> <span class="operator">=</span> SQLUtils.toSQLExpr(<span class="string">&quot;id=3&quot;</span>, dbType);</span><br></pre></td></tr></table></figure>

<h3 id="4-怎样打印AST节点"><a href="#4-怎样打印AST节点" class="headerlink" title="4. 怎样打印AST节点"></a>4. 怎样打印AST节点</h3><h4 id="4-1-通过SQLUtils工具类打印节点"><a href="#4-1-通过SQLUtils工具类打印节点" class="headerlink" title="4.1. 通过SQLUtils工具类打印节点"></a>4.1. 通过SQLUtils工具类打印节点</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.druid.sql;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLUtils</span> &#123;</span><br><span class="line">    <span class="comment">// 可以将SQLExpr/SQLStatement打印为String类型</span></span><br><span class="line">    <span class="keyword">static</span> String <span class="title function_">toSQLString</span><span class="params">(SQLObject sqlObj, String dbType)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以将一个&amp;lt;SQLStatement&amp;gt;打印为String类型</span></span><br><span class="line">    <span class="keyword">static</span> String <span class="title function_">toSQLString</span><span class="params">(List&lt;SQLStatement&gt; statementList, String dbType)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-如何自定义遍历AST节点"><a href="#5-如何自定义遍历AST节点" class="headerlink" title="5. 如何自定义遍历AST节点"></a>5. 如何自定义遍历AST节点</h3><p>所有的AST节点都支持Visitor模式，需要自定义遍历逻辑，可以实现相应的ASTVisitorAdapter派生类，比如 <a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/SQL_Parser_Demo_visitor">https://github.com/alibaba/druid/wiki/SQL_Parser_Demo_visitor</a></p>
<h3 id="6-相关阅读"><a href="#6-相关阅读" class="headerlink" title="6. 相关阅读"></a>6. 相关阅读</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/SQL-Parser">https://github.com/alibaba/druid/wiki/SQL-Parser</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/SQL_Schema_Repository">https://github.com/alibaba/druid/wiki/SQL_Schema_Repository</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/SQL_RemoveCondition_demo">https://github.com/alibaba/druid/wiki/SQL_RemoveCondition_demo</a></li>
</ul>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">LemonGo97</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.lemongo97.com/posts/6d9855d0/">https://blog.lemongo97.com/posts/6d9855d0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.lemongo97.com" target="_blank">LemonGo97のBlog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/SQL/">SQL</a><a class="post-meta__tags" href="/tags/Druid/">Druid</a></div><div class="post_share"><div class="social-share" data-image="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200804141920.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/34ad406f/"><img class="prev-cover" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200915180256.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">HBase 集群安装</div></div></a></div><div class="next-post pull-right"><a href="/posts/a097aeed/"><img class="next-cover" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200804150229.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Zookeeper 入门</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/posts/7de3e7aa/" title="Curator实现Zookeeper注册中心（官方文档翻译）"><img class="relatedPosts_cover" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20201225124820.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-24</div><div class="relatedPosts_title">Curator实现Zookeeper注册中心（官方文档翻译）</div></div></a></div><div class="relatedPosts_item"><a href="/posts/8662ab0e/" title="Java 网络编程之 SSL加密连接"><img class="relatedPosts_cover" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/default_cover_1.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-06</div><div class="relatedPosts_title">Java 网络编程之 SSL加密连接</div></div></a></div><div class="relatedPosts_item"><a href="/posts/a097aeed/" title="Zookeeper 入门"><img class="relatedPosts_cover" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200804150229.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-13</div><div class="relatedPosts_title">Zookeeper 入门</div></div></a></div><div class="relatedPosts_item"><a href="/posts/3611deb6/" title="LinkedList 源码分析"><img class="relatedPosts_cover" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/all_default.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-23</div><div class="relatedPosts_title">LinkedList 源码分析</div></div></a></div><div class="relatedPosts_item"><a href="/posts/7a6cb371/" title="一个简单的页面分页显隐算法"><img class="relatedPosts_cover" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/all_default.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-23</div><div class="relatedPosts_title">一个简单的页面分页显隐算法</div></div></a></div><div class="relatedPosts_item"><a href="/posts/34ad406f/" title="HBase 集群安装"><img class="relatedPosts_cover" data-lazy-src="https://lemongo97-blog-img.oss-cn-beijing.aliyuncs.com/20200915180256.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-15</div><div class="relatedPosts_title">HBase 集群安装</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By LemonGo97</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/instant.page/5.1.0/instantpage.min.js" type="module" defer></script><script src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.3.1/lazyload.iife.min.js" async></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    window.valine = new Valine({
      el: '#vcomment',
      appId: 'w7vT5VedMPyGHyDYppcacmtw-gzGzoHsz',
      appKey: 'YxBl09Aj50g5Ld621aydI4pz',
      placeholder: '来和大家一起讨论吧！',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    });
    if ('nick,mail') { valine.config.requiredFields= 'nick,mail'.split(',') }
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div></div></body></html>